<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markov Chain Text Generator</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/components.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Markov Chain Text Generator</h1>
        <p>Generate new text based on patterns learned from your input</p>
      </header>

      <main class="main-content">
        <nav class="breadcrumbs">
          <a href="/">Home</a>
          <span class="separator">/</span>
          <a href="/javascript/">JavaScript</a>
          <span class="separator">/</span>
          <span class="current">Markov Chain</span>
        </nav>

        <section class="section">
          <h2>Generator</h2>
          <div class="form-group">
            <label for="input-text">Input Text (paste your source text here):</label>
            <textarea
              id="input-text"
              placeholder="Paste some text here to train the Markov chain..."
              class="form-textarea"
            ></textarea>
          </div>

          <div class="form-inline-group">
            <div class="form-group">
              <label for="ngram-type">N-gram Type:</label>
              <select id="ngram-type" class="form-select">
                <option value="char">Characters</option>
                <option value="word">Words</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ngram-size">N-gram Size:</label>
              <select id="ngram-size" class="form-select">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
              </select>
            </div>
            <div class="form-group">
              <label for="output-length">Output Length:</label>
              <select id="output-length" class="form-select">
                <option value="100">100 characters</option>
                <option value="200" selected>200 characters</option>
                <option value="500">500 characters</option>
              </select>
            </div>
          </div>

          <button id="generate" class="submit-btn">Generate Text</button>

          <div class="form-group">
            <label>Generated Output:</label>
            <div id="output" class="output-box"></div>
          </div>

          <details class="section">
            <summary style="cursor: pointer; font-weight: 600; margin-bottom: 1rem">
              Show Probabilities
            </summary>
            <div id="probabilities"></div>
          </details>
        </section>

        <section class="section info-box">
          <h3>What are Markov Chains?</h3>
          <p>
            A Markov chain is a mathematical model that predicts the next state based only on the
            current state, without considering the full history. In text generation, we use n-grams
            (sequences of n characters or words) to build a model that predicts what comes next
            based on the current n-gram.
          </p>
          <p>
            This generator uses the input text to build a probability model, then generates new text
            by randomly selecting the next character or word based on the learned probabilities.
          </p>
        </section>

        <section class="section">
          <h2>Navigation</h2>
          <ul class="external-links">
            <li><a href="/javascript/">← Back to JavaScript experiments</a></li>
            <li><a href="/">← Back to main page</a></li>
          </ul>
        </section>
      </main>
    </div>

    <script type="module">
      import { MarkovChain } from "./markov.js"

      let chain = null

      /**
       * Generates text using the Markov chain based on current settings
       */
      function generate() {
        const inputText = document.getElementById("input-text").value
        const outputDiv = document.getElementById("output")
        const probabilitiesDiv = document.getElementById("probabilities")
        const ngramType = document.getElementById("ngram-type").value
        const ngramSize = parseInt(document.getElementById("ngram-size").value)
        const outputLength = parseInt(document.getElementById("output-length").value)

        if (!inputText.trim()) {
          outputDiv.textContent = "Please enter some input text first."
          probabilitiesDiv.innerHTML = ""
          return
        }

        try {
          chain = new MarkovChain(inputText, ngramType, ngramSize)
          const generated = chain.generate(outputLength)
          outputDiv.textContent = generated

          // Show probabilities
          const transitions = chain.getTransitions()
          let html = "<h4>Transition Probabilities (sample):</h4>"

          const entries = Object.entries(transitions).slice(0, 10)
          for (const [ngram, possibilities] of entries) {
            const totalCount = Object.values(possibilities).reduce((a, b) => a + b, 0)
            html += `<div class="probability-sample">`
            html += `<strong>${JSON.stringify(ngram)}</strong> →<br>`
            for (const [next, count] of Object.entries(possibilities)) {
              const prob = ((count / totalCount) * 100).toFixed(1)
              html += `&nbsp;&nbsp;${JSON.stringify(next)}: ${prob}% (${count}/${totalCount})<br>`
            }
            html += `</div>`
          }

          probabilitiesDiv.innerHTML = html
        } catch (error) {
          outputDiv.textContent = `Error: ${error.message}`
          probabilitiesDiv.innerHTML = ""
        }
      }

      document.getElementById("generate").addEventListener("click", generate)

      // Auto-generate on input if there's text
      document.getElementById("input-text").addEventListener("input", () => {
        if (document.getElementById("input-text").value.trim()) {
          generate()
        }
      })

      // Load default example text
      document.getElementById("input-text").value =
        "To be or not to be, that is the question. Whether tis nobler in the mind to suffer the slings and arrows of outrageous fortune, or to take arms against a sea of troubles."
      generate()
    </script>
  </body>
</html>
